name: ç”¨æˆ·è®¤è¯æµç¨‹æµ‹è¯•æµæ°´çº¿ï¼ˆç®€åŒ–ç‰ˆï¼‰

# è§¦å‘æ¡ä»¶ï¼šæ¨é€åˆ°ä»»æ„åˆ†æ”¯æˆ–åˆ›å»ºPull Request
on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]

# å…¨å±€ç¯å¢ƒå˜é‡
env:
  PYTHON_VERSION: '3.10'

jobs:
  auth-test:
    name: ç”¨æˆ·è®¤è¯æµç¨‹æµ‹è¯•
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install requests pyyaml
          # å®‰è£… Drun æ¡†æ¶
          pip install git+https://github.com/Devliang24/drun.git

      - name: åˆ›å»ºå¿…è¦ç›®å½•
        run: |
          mkdir -p reports
          mkdir -p logs

      - name: å‘é€æµ‹è¯•å¼€å§‹é€šçŸ¥ï¼ˆé£ä¹¦ï¼‰
        if: always()
        run: |
          # ç®€åŒ–çš„é£ä¹¦é€šçŸ¥ - æ–‡æœ¬æ ¼å¼
          payload='{
            "msg_type": "text",
            "content": {
              "text": "ğŸš€ ç”¨æˆ·è®¤è¯æµç¨‹æµ‹è¯•å¼€å§‹\n\nğŸ“Š æµ‹è¯•é¡¹ç›®: E-commerce API ç”¨æˆ·è®¤è¯æµ‹è¯•\nğŸ”„ è§¦å‘æ–¹å¼: ${{ github.event_name }}\nğŸŒ¿ åˆ†æ”¯: ${{ github.ref_name }}\nğŸ‘¤ æäº¤è€…: ${{ github.actor }}\nğŸ“ æäº¤ä¿¡æ¯: ${{ github.event.head_commit.message }}\nğŸ“‹ æµ‹è¯•ç”¨ä¾‹: test_auth_flow.yaml\n\nğŸ”— æŸ¥çœ‹æäº¤: ${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}"
            }
          }'

          # æ£€æŸ¥æ˜¯å¦é…ç½®äº†é£ä¹¦Webhook
          if [ -n "${{ secrets.FEISHU_WEBHOOK_URL }}" ]; then
            echo "âœ… æ£€æµ‹åˆ°é£ä¹¦Webhook URLï¼Œå¼€å§‹å‘é€é€šçŸ¥..."
            echo "ğŸ“¤ å‘é€æµ‹è¯•å¼€å§‹é€šçŸ¥..."

            response=$(curl -s -w "\nHTTP_CODE:%{http_code}" -X POST "${{ secrets.FEISHU_WEBHOOK_URL }}" \
              -H "Content-Type: application/json" \
              -d "$payload")

            http_code=$(echo "$response" | grep -o 'HTTP_CODE:[0-9]*' | cut -d: -f2)
            response_body=$(echo "$response" | sed -e 's/HTTP_CODE:[0-9]*$//')

            echo "ğŸ“Š HTTPçŠ¶æ€ç : $http_code"
            echo "ğŸ“„ å“åº”å†…å®¹: $response_body"

            if [ "$http_code" = "200" ]; then
              echo "âœ… é£ä¹¦é€šçŸ¥å‘é€æˆåŠŸ"
            else
              echo "âŒ é£ä¹¦é€šçŸ¥å‘é€å¤±è´¥ (HTTP $http_code)"
              echo "ğŸ” å“åº”è¯¦æƒ…: $response_body"
            fi
          else
            echo "âš ï¸ æœªé…ç½®é£ä¹¦Webhook URLï¼Œè·³è¿‡é€šçŸ¥å‘é€"
          fi

      - name: è¿è¡Œç”¨æˆ·è®¤è¯æµ‹è¯•
        id: run-test
        run: |
          echo "å¼€å§‹æ‰§è¡Œç”¨æˆ·è®¤è¯æµç¨‹æµ‹è¯•..."

          # ä½¿ç”¨é¡¹ç›®ä¸­çš„.envæ–‡ä»¶
          if [ -f ".env" ]; then
            echo "æ‰¾åˆ°.envé…ç½®æ–‡ä»¶ï¼ŒåŠ è½½ç¯å¢ƒå˜é‡"
            # å®‰å…¨åœ°è¯»å–.envæ–‡ä»¶å¹¶è®¾ç½®ä¸ºç¯å¢ƒå˜é‡
            while IFS= read -r line; do
              # è·³è¿‡æ³¨é‡Šè¡Œå’Œç©ºè¡Œ
              if [[ ! "$line" =~ ^[[:space:]]*# ]] && [[ -n "$line" ]]; then
                # ä½¿ç”¨exportå‘½ä»¤è®¾ç½®ç¯å¢ƒå˜é‡ï¼Œæ­£ç¡®å¤„ç†åŒ…å«ç©ºæ ¼çš„å€¼
                export "$line"
              fi
            done < .env
          else
            echo "è­¦å‘Šï¼šæœªæ‰¾åˆ°.envæ–‡ä»¶"
            exit 1
          fi

          # åˆ›å»ºæµ‹è¯•æŠ¥å‘Šç›®å½•
          timestamp=$(date +%Y%m%d_%H%M%S)
          report_dir="reports/auth_${timestamp}"
          mkdir -p "$report_dir"

          # è¿è¡Œç”¨æˆ·è®¤è¯æµç¨‹æµ‹è¯•å¹¶ç”ŸæˆæŠ¥å‘Š
          echo "æ‰§è¡Œæµ‹è¯•å‘½ä»¤: drun run testcases/test_auth_flow.yaml"

          # éªŒè¯drunæ˜¯å¦å¯ç”¨
          if ! command -v drun &> /dev/null; then
            echo "âŒ drunå‘½ä»¤æœªæ‰¾åˆ°ï¼Œå®‰è£…å¤±è´¥"
            exit 1
          fi

          # æ‰§è¡Œæµ‹è¯•
          if drun run testcases/test_auth_flow.yaml \
            --html "$report_dir/auth_report.html" \
            --report "$report_dir/auth_report.json" \
            --log-level info; then

            echo "âœ… ç”¨æˆ·è®¤è¯æµç¨‹æµ‹è¯•æ‰§è¡ŒæˆåŠŸ"
            echo "test_status=success" >> $GITHUB_OUTPUT
            echo "report_dir=$report_dir" >> $GITHUB_OUTPUT

          else
            echo "âŒ ç”¨æˆ·è®¤è¯æµç¨‹æµ‹è¯•æ‰§è¡Œå¤±è´¥"
            echo "test_status=failure" >> $GITHUB_OUTPUT
            echo "report_dir=$report_dir" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: å‘é€æµ‹è¯•ç»“æœé€šçŸ¥ï¼ˆé£ä¹¦ï¼‰
        if: always()
        run: |
          # æ ¹æ®æµ‹è¯•ç»“æœå‘é€ä¸åŒé€šçŸ¥
          if [ "${{ steps.run-test.outputs.test_status }}" == "success" ]; then
            # æˆåŠŸé€šçŸ¥
            payload='{
              "msg_type": "text",
              "content": {
                "text": "âœ… ç”¨æˆ·è®¤è¯æµç¨‹æµ‹è¯•é€šè¿‡\n\nğŸ“Š æµ‹è¯•ç»“æœ: å…¨éƒ¨é€šè¿‡ âœ…\nğŸ“‹ æµ‹è¯•ç”¨ä¾‹: test_auth_flow.yaml\nâ° æ‰§è¡Œæ—¶é—´: '$(date '+%Y-%m-%d %H:%M:%S')'\nğŸŒ¿ åˆ†æ”¯: ${{ github.ref_name }}\nğŸ‘¤ æäº¤è€…: ${{ github.actor }}\nğŸ“ æäº¤ä¿¡æ¯: ${{ github.event.head_commit.message }}\n\nğŸ”— æŸ¥çœ‹æµ‹è¯•æŠ¥å‘Š: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
              }
            }'
            echo "ğŸ“¤ å‘é€æµ‹è¯•æˆåŠŸé€šçŸ¥..."
          else
            # å¤±è´¥é€šçŸ¥
            payload='{
              "msg_type": "text",
              "content": {
                "text": "âŒ ç”¨æˆ·è®¤è¯æµç¨‹æµ‹è¯•å¤±è´¥\n\nğŸ“Š æµ‹è¯•ç»“æœ: å¤±è´¥ âŒ\nğŸ“‹ æµ‹è¯•ç”¨ä¾‹: test_auth_flow.yaml\nâ° å¤±è´¥æ—¶é—´: '$(date '+%Y-%m-%d %H:%M:%S')'\nğŸŒ¿ åˆ†æ”¯: ${{ github.ref_name }}\nğŸ‘¤ æäº¤è€…: ${{ github.actor }}\nğŸ“ æäº¤ä¿¡æ¯: ${{ github.event.head_commit.message }}\n\nè¯·åŠæ—¶æ£€æŸ¥æµ‹è¯•å¤±è´¥åŸå› å¹¶ä¿®å¤é—®é¢˜ï¼\n\nğŸ”— æŸ¥çœ‹æµ‹è¯•æ—¥å¿—: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
              }
            }'
            echo "ğŸ“¤ å‘é€æµ‹è¯•å¤±è´¥é€šçŸ¥..."
          fi

          # æ£€æŸ¥æ˜¯å¦é…ç½®äº†é£ä¹¦Webhook
          if [ -n "${{ secrets.FEISHU_WEBHOOK_URL }}" ]; then
            response=$(curl -s -w "\nHTTP_CODE:%{http_code}" -X POST "${{ secrets.FEISHU_WEBHOOK_URL }}" \
              -H "Content-Type: application/json" \
              -d "$payload")

            http_code=$(echo "$response" | grep -o 'HTTP_CODE:[0-9]*' | cut -d: -f2)
            response_body=$(echo "$response" | sed -e 's/HTTP_CODE:[0-9]*$//')

            if [ "$http_code" = "200" ]; then
              echo "âœ… é£ä¹¦é€šçŸ¥å‘é€æˆåŠŸ"
            else
              echo "âŒ é£ä¹¦é€šçŸ¥å‘é€å¤±è´¥ (HTTP $http_code)"
              echo "ğŸ” å“åº”è¯¦æƒ…: $response_body"
            fi
          else
            echo "æœªé…ç½®é£ä¹¦Webhook URLï¼Œè·³è¿‡é€šçŸ¥å‘é€"
          fi

      - name: ä¸Šä¼ æµ‹è¯•æŠ¥å‘Š
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: auth-test-reports
          path: reports/
          retention-days: 30

      - name: æ˜¾ç¤ºæµ‹è¯•æŠ¥å‘Šæ‘˜è¦
        if: always()
        run: |
          echo "## ğŸ“Š ç”¨æˆ·è®¤è¯æµ‹è¯•æŠ¥å‘Šæ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.run-test.outputs.test_status }}" == "success" ]; then
            echo "âœ… **æµ‹è¯•çŠ¶æ€**: é€šè¿‡" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **æµ‹è¯•çŠ¶æ€**: å¤±è´¥" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“‹ æµ‹è¯•ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "- **æµ‹è¯•ç”¨ä¾‹**: test_auth_flow.yaml" >> $GITHUB_STEP_SUMMARY
          echo "- **æ‰§è¡Œæ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
          echo "- **åˆ†æ”¯**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æäº¤è€…**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æäº¤ä¿¡æ¯**: ${{ github.event.head_commit.message }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“ æµ‹è¯•æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "æµ‹è¯•æŠ¥å‘Šå·²ä¸Šä¼ åˆ° GitHub Actions Artifactsï¼Œå¯åœ¨æœ¬æ¬¡è¿è¡Œè®°å½•ä¸­ä¸‹è½½æŸ¥çœ‹ã€‚" >> $GITHUB_STEP_SUMMARY