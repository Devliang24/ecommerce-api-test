name: E2Eä¸šåŠ¡æµç¨‹æµ‹è¯•æµæ°´çº¿

# è§¦å‘æ¡ä»¶ï¼šæ¨é€åˆ°ä»»æ„åˆ†æ”¯æˆ–åˆ›å»ºPull Request
on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]

# å…¨å±€ç¯å¢ƒå˜é‡
env:
  PYTHON_VERSION: '3.10'

jobs:
  e2e-test:
    name: E2Eä¸šåŠ¡æµç¨‹æµ‹è¯•
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install requests pyyaml
          # å¦‚æœdrunæœ‰å…¶ä»–ä¾èµ–ï¼Œè¯·åœ¨è¿™é‡Œæ·»åŠ 

      - name: åˆ›å»ºå¿…è¦ç›®å½•
        run: |
          mkdir -p reports
          mkdir -p logs

      - name: å‘é€æµ‹è¯•å¼€å§‹é€šçŸ¥ï¼ˆé£ä¹¦ï¼‰
        if: always()
        run: |
          # å‘é€æµ‹è¯•å¼€å§‹é€šçŸ¥
          payload=$(cat <<EOF
          {
            "msg_type": "interactive",
            "card": {
              "config": {
                "wide_screen_mode": true
              },
              "header": {
                "template": "blue",
                "title": {
                  "content": "ğŸš€ E2Eä¸šåŠ¡æµç¨‹æµ‹è¯•å¼€å§‹",
                  "tag": "plain_text"
                }
              },
              "elements": [
                {
                  "tag": "div",
                  "text": {
                    "content": "**æµ‹è¯•é¡¹ç›®**: E-commerce API E2Eæµ‹è¯•\n**è§¦å‘æ–¹å¼**: ${{ github.event_name }}\n**åˆ†æ”¯**: ${{ github.ref_name }}\n**æäº¤è€…**: ${{ github.actor }}\n**æäº¤ä¿¡æ¯**: ${{ github.event.head_commit.message }}\n**æµ‹è¯•ç”¨ä¾‹**: test_e2e_purchase.yaml",
                    "tag": "lark_md"
                  }
                },
                {
                  "tag": "action",
                  "actions": [
                    {
                      "tag": "button",
                      "text": {
                        "content": "æŸ¥çœ‹æäº¤",
                        "tag": "plain_text"
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}"
                    }
                  ]
                }
              ]
            }
          }
          EOF
          )

          curl -X POST "${{ secrets.FEISHU_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d "$payload" || echo "é£ä¹¦é€šçŸ¥å‘é€å¤±è´¥ï¼Œç»§ç»­æ‰§è¡Œæµ‹è¯•"

      - name: è¿è¡ŒE2Eæµ‹è¯•
        id: run-test
        run: |
          echo "å¼€å§‹æ‰§è¡ŒE2Eä¸šåŠ¡æµç¨‹æµ‹è¯•..."

          # ä½¿ç”¨é¡¹ç›®ä¸­çš„.envæ–‡ä»¶
          if [ -f ".env" ]; then
            echo "æ‰¾åˆ°.envé…ç½®æ–‡ä»¶ï¼ŒåŠ è½½ç¯å¢ƒå˜é‡"
            # å®‰å…¨åœ°è¯»å–.envæ–‡ä»¶å¹¶è®¾ç½®ä¸ºç¯å¢ƒå˜é‡
            while IFS= read -r line; do
              # è·³è¿‡æ³¨é‡Šè¡Œå’Œç©ºè¡Œ
              if [[ ! "$line" =~ ^[[:space:]]*# ]] && [[ -n "$line" ]]; then
                # ä½¿ç”¨exportå‘½ä»¤è®¾ç½®ç¯å¢ƒå˜é‡ï¼Œæ­£ç¡®å¤„ç†åŒ…å«ç©ºæ ¼çš„å€¼
                export "$line"
              fi
            done < .env
          else
            echo "è­¦å‘Šï¼šæœªæ‰¾åˆ°.envæ–‡ä»¶"
            exit 1
          fi

          # åˆ›å»ºæµ‹è¯•æŠ¥å‘Šç›®å½•
          timestamp=$(date +%Y%m%d_%H%M%S)
          report_dir="reports/e2e_${timestamp}"
          mkdir -p "$report_dir"

          # è¿è¡ŒE2Eæµ‹è¯•å¹¶ç”ŸæˆæŠ¥å‘Š
          echo "æ‰§è¡Œæµ‹è¯•å‘½ä»¤: drun run testcases/test_e2e_purchase.yaml"

          # æ£€æŸ¥drunæ˜¯å¦å¯ç”¨
          if ! command -v drun &> /dev/null; then
            echo "drunæœªå®‰è£…ï¼Œå°è¯•å®‰è£…..."
            # è¿™é‡Œå¯èƒ½éœ€è¦æ ¹æ®å®é™…çš„drunå®‰è£…æ–¹å¼è°ƒæ•´
            pip install drun-framework || echo "è¯·æ‰‹åŠ¨å®‰è£…drunæ¡†æ¶"
          fi

          # æ‰§è¡Œæµ‹è¯•
          if drun run testcases/test_e2e_purchase.yaml \
            --html "$report_dir/e2e_report.html" \
            --report "$report_dir/e2e_report.json" \
            --log-level info; then

            echo "âœ… E2Eæµ‹è¯•æ‰§è¡ŒæˆåŠŸ"
            echo "test_status=success" >> $GITHUB_OUTPUT
            echo "report_dir=$report_dir" >> $GITHUB_OUTPUT

          else
            echo "âŒ E2Eæµ‹è¯•æ‰§è¡Œå¤±è´¥"
            echo "test_status=failure" >> $GITHUB_OUTPUT
            echo "report_dir=$report_dir" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: å‘é€æµ‹è¯•æˆåŠŸé€šçŸ¥ï¼ˆé£ä¹¦ï¼‰
        if: steps.run-test.outputs.test_status == 'success'
        run: |
          payload=$(cat <<EOF
          {
            "msg_type": "interactive",
            "card": {
              "config": {
                "wide_screen_mode": true
              },
              "header": {
                "template": "green",
                "title": {
                  "content": "âœ… E2Eä¸šåŠ¡æµç¨‹æµ‹è¯•é€šè¿‡",
                  "tag": "plain_text"
                }
              },
              "elements": [
                {
                  "tag": "div",
                  "text": {
                    "content": "**æµ‹è¯•ç»“æœ**: å…¨éƒ¨é€šè¿‡ âœ…\n**æµ‹è¯•ç”¨ä¾‹**: test_e2e_purchase.yaml\n**æ‰§è¡Œæ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S')\n**åˆ†æ”¯**: ${{ github.ref_name }}\n**æäº¤è€…**: ${{ github.actor }}\n**æäº¤ä¿¡æ¯**: ${{ github.event.head_commit.message }}",
                    "tag": "lark_md"
                  }
                },
                {
                  "tag": "action",
                  "actions": [
                    {
                      "tag": "button",
                      "text": {
                        "content": "æŸ¥çœ‹æµ‹è¯•æŠ¥å‘Š",
                        "tag": "plain_text"
                      },
                      "type": "primary",
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    },
                    {
                      "tag": "button",
                      "text": {
                        "content": "æŸ¥çœ‹æäº¤",
                        "tag": "plain_text"
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}"
                    }
                  ]
                }
              ]
            }
          }
          EOF
          )

          curl -X POST "${{ secrets.FEISHU_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d "$payload" || echo "é£ä¹¦é€šçŸ¥å‘é€å¤±è´¥"

      - name: å‘é€æµ‹è¯•å¤±è´¥é€šçŸ¥ï¼ˆé£ä¹¦ï¼‰
        if: steps.run-test.outputs.test_status == 'failure'
        run: |
          payload=$(cat <<EOF
          {
            "msg_type": "interactive",
            "card": {
              "config": {
                "wide_screen_mode": true
              },
              "header": {
                "template": "red",
                "title": {
                  "content": "âŒ E2Eä¸šåŠ¡æµç¨‹æµ‹è¯•å¤±è´¥",
                  "tag": "plain_text"
                }
              },
              "elements": [
                {
                  "tag": "div",
                  "text": {
                    "content": "**æµ‹è¯•ç»“æœ**: å¤±è´¥ âŒ\n**æµ‹è¯•ç”¨ä¾‹**: test_e2e_purchase.yaml\n**å¤±è´¥æ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S')\n**åˆ†æ”¯**: ${{ github.ref_name }}\n**æäº¤è€…**: ${{ github.actor }}\n**æäº¤ä¿¡æ¯**: ${{ github.event.head_commit.message }}\n\nè¯·åŠæ—¶æ£€æŸ¥æµ‹è¯•å¤±è´¥åŸå› å¹¶ä¿®å¤é—®é¢˜ï¼",
                    "tag": "lark_md"
                  }
                },
                {
                  "tag": "action",
                  "actions": [
                    {
                      "tag": "button",
                      "text": {
                        "content": "æŸ¥çœ‹æµ‹è¯•æ—¥å¿—",
                        "tag": "plain_text"
                      },
                      "type": "danger",
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    },
                    {
                      "tag": "button",
                      "text": {
                        "content": "æŸ¥çœ‹æäº¤",
                        "tag": "plain_text"
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}"
                    }
                  ]
                }
              ]
            }
          }
          EOF
          )

          curl -X POST "${{ secrets.FEISHU_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d "$payload" || echo "é£ä¹¦é€šçŸ¥å‘é€å¤±è´¥"

      - name: ä¸Šä¼ æµ‹è¯•æŠ¥å‘Š
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-reports
          path: reports/
          retention-days: 30

      - name: æ˜¾ç¤ºæµ‹è¯•æŠ¥å‘Šæ‘˜è¦
        if: always()
        run: |
          echo "## ğŸ“Š E2Eæµ‹è¯•æŠ¥å‘Šæ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.run-test.outputs.test_status }}" == "success" ]; then
            echo "âœ… **æµ‹è¯•çŠ¶æ€**: é€šè¿‡" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **æµ‹è¯•çŠ¶æ€**: å¤±è´¥" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“‹ æµ‹è¯•ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "- **æµ‹è¯•ç”¨ä¾‹**: test_e2e_purchase.yaml" >> $GITHUB_STEP_SUMMARY
          echo "- **æ‰§è¡Œæ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
          echo "- **åˆ†æ”¯**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æäº¤è€…**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æäº¤ä¿¡æ¯**: ${{ github.event.head_commit.message }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“ æµ‹è¯•æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "æµ‹è¯•æŠ¥å‘Šå·²ä¸Šä¼ åˆ° GitHub Actions Artifactsï¼Œå¯åœ¨æœ¬æ¬¡è¿è¡Œè®°å½•ä¸­ä¸‹è½½æŸ¥çœ‹ã€‚" >> $GITHUB_STEP_SUMMARY