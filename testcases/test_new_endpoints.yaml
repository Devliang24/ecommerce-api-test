config:
  name: 新增API端点测试
  base_url: ${ENV(BASE_URL)}
  tags: [new-endpoints, regression]
  variables:
    test_username: new_user_${short_uid(8)}
    test_email: new_${short_uid(8)}@example.com
    test_password: ${ENV(USER_PASSWORD)}
    test_address: ${ENV(SHIPPING_ADDRESS)}

steps:
  # 快速商品搜索测试

  - name: 快速商品搜索
    request:
      method: POST
      path: /api/v1/products/quick-search
      headers:
        Content-Type: application/json
      body:
        query: "test"
        limit: 5
    validate:
      - eq: [status_code, 200]
      - eq: [$.success, true]

  # 订单搜索测试

  - name: 注册测试用户
    request:
      method: POST
      path: /api/v1/auth/register
      headers:
        Content-Type: application/json
      body:
        username: $test_username
        email: $test_email
        password: $test_password
        full_name: New API Test User
        shipping_address: $test_address
    validate:
      - eq: [status_code, 201]


  - name: 登录获取token
    request:
      method: POST
      path: /api/v1/auth/login
      headers:
        Content-Type: application/json
      body:
        username: $test_username
        password: $test_password
    extract:
      token: $.data.access_token
    validate:
      - eq: [status_code, 200]


  - name: 获取商品并添加到购物车
    request:
      method: GET
      path: /api/v1/products/?in_stock=true&limit=1
    extract:
      product_id: $.data.items[0].id
    validate:
      - eq: [status_code, 200]


  - name: 使用兼容接口添加商品到购物车
    request:
      method: POST
      path: /api/v1/cart/add
      headers:
        Authorization: Bearer $token
        Content-Type: application/json
      body:
        product_id: $product_id
        quantity: 1
    validate:
      - eq: [status_code, 201]


  - name: 创建订单
    request:
      method: POST
      path: /api/v1/orders/
      headers:
        Authorization: Bearer $token
        Content-Type: application/json
      body:
        shipping_address: $test_address
    extract:
      order_id: $.data.id
    validate:
      - eq: [status_code, 201]


  - name: 订单结账
    request:
      method: POST
      path: /api/v1/orders/checkout
      headers:
        Authorization: Bearer $token
        Content-Type: application/json
      body:
        shipping_address: $test_address
    validate:
      - eq: [status_code, 201]
      - eq: [$.success, true]


  - name: 订单搜索
    request:
      method: POST
      path: /api/v1/orders/search
      headers:
        Authorization: Bearer $token
        Content-Type: application/json
      body:
        status: "pending"
        limit: 10
    validate:
      - eq: [status_code, 200]
      - eq: [$.success, true]

  # 管理员订单搜索测试

  - name: 管理员登录
    request:
      method: POST
      path: /api/v1/auth/login
      headers:
        Content-Type: application/json
      body:
        username: ${ENV(ADMIN_USERNAME)}
        password: ${ENV(ADMIN_PASSWORD)}
    extract:
      admin_token: $.data.access_token
    validate:
      - eq: [status_code, 200]


  - name: 管理员订单搜索
    request:
      method: POST
      path: /api/v1/orders/admin/search
      headers:
        Authorization: Bearer $admin_token
        Content-Type: application/json
      body:
        status: "pending"
        limit: 20
    validate:
      - eq: [status_code, 200]
      - eq: [$.success, true]


  - name: 使用兼容接口移除购物车商品
    request:
      method: DELETE
      path: /api/v1/cart/remove/$product_id
      headers:
        Authorization: Bearer $token
    validate:
      - eq: [status_code, 200]
